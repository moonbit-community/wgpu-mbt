name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  linux:
    name: Linux (build-only)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install MoonBit
        shell: bash
        run: |
          set -euo pipefail
          curl -fsSL https://cli.moonbitlang.com/install/unix.sh | bash
          echo "MOON_HOME=$HOME/.moon" >> "$GITHUB_ENV"
          echo "$HOME/.moon/bin" >> "$GITHUB_PATH"

      - name: Moon version
        shell: bash
        run: moon version --all

      - name: Lint (moon check)
        shell: bash
        run: moon check

      - name: Compile tests (no runtime deps)
        shell: bash
        run: moon test --build-only --target native

  macos:
    name: macOS (build-only)
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install MoonBit
        shell: bash
        run: |
          set -euo pipefail
          curl -fsSL https://cli.moonbitlang.com/install/unix.sh | bash
          echo "MOON_HOME=$HOME/.moon" >> "$GITHUB_ENV"
          echo "$HOME/.moon/bin" >> "$GITHUB_PATH"

      - name: Moon version
        shell: bash
        run: moon version --all

      - name: Lint (moon check)
        shell: bash
        run: moon check

      - name: Compile tests (no runtime deps)
        shell: bash
        run: moon test --build-only --target native

  windows:
    name: Windows (build-only)
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install MoonBit
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $zipUrl = "https://cli.moonbitlang.com/binaries/latest/moonbit-windows-x86_64.zip"
          $zipPath = Join-Path $env:RUNNER_TEMP "moonbit.zip"
          $moonHome = Join-Path $env:USERPROFILE ".moon"

          Invoke-WebRequest -Uri $zipUrl -OutFile $zipPath
          New-Item -ItemType Directory -Force -Path $moonHome | Out-Null
          Expand-Archive -Path $zipPath -DestinationPath $moonHome -Force

          "MOON_HOME=$moonHome" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          (Join-Path $moonHome "bin") | Out-File -FilePath $env:GITHUB_PATH -Append -Encoding utf8

      - name: Moon version
        shell: pwsh
        run: moon version --all

      - name: Lint (moon check)
        shell: pwsh
        run: moon check

      - name: Compile tests (no runtime deps)
        shell: pwsh
        run: moon test --build-only --target native
