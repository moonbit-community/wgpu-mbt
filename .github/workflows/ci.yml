name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  # NOTE: ba4deb5d (v27.0.4.0-1) regressed in GitHub-hosted runners (requestAdapter/RequestDevice
  # returns Success with a NULL handle). Pin to the v27.0.4.0 tag commit.
  WGPU_NATIVE_REV: 768f15f6ace8e4ec8e8720d5732b29e0b34250a8

jobs:
  linux:
    name: Linux Vulkan (full)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system deps (Vulkan + bindgen)
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y libvulkan1 mesa-vulkan-drivers vulkan-tools clang libclang-dev pkg-config

      - name: Configure Vulkan ICD (lavapipe)
        shell: bash
        run: |
          set -euo pipefail
          echo "Available Vulkan ICDs:"
          ls -la /usr/share/vulkan/icd.d || true

          icd=""
          for cand in /usr/share/vulkan/icd.d/lvp_icd.x86_64.json /usr/share/vulkan/icd.d/lvp_icd.json; do
            if [ -f "$cand" ]; then
              icd="$cand"
              break
            fi
          done
          if [ -n "$icd" ]; then
            echo "Using ICD: $icd"
            echo "VK_ICD_FILENAMES=$icd" >> "$GITHUB_ENV"
          else
            echo "No lavapipe ICD found; continuing with default loader search."
          fi

          vulkaninfo --summary || true

      - name: Install MoonBit
        shell: bash
        run: |
          set -euo pipefail
          curl -fsSL https://cli.moonbitlang.com/install/unix.sh | bash
          echo "MOON_HOME=$HOME/.moon" >> "$GITHUB_ENV"
          echo "$HOME/.moon/bin" >> "$GITHUB_PATH"

      - name: Moon version
        shell: bash
        run: moon version --all

      - name: Lint (moon check)
        shell: bash
        run: moon check

      - name: Build wgpu-native (Vulkan)
        shell: bash
        run: |
          set -euo pipefail
          git clone --depth 1 --recurse-submodules --shallow-submodules https://github.com/gfx-rs/wgpu-native "$RUNNER_TEMP/wgpu-native"
          cd "$RUNNER_TEMP/wgpu-native"
          git fetch --depth 1 origin "$WGPU_NATIVE_REV"
          git checkout "$WGPU_NATIVE_REV"
          git submodule update --init --recursive --depth 1
          cargo build --release --no-default-features --features vulkan,wgsl,spirv
          echo "MBT_WGPU_NATIVE_LIB=$RUNNER_TEMP/wgpu-native/target/release/libwgpu_native.so" >> "$GITHUB_ENV"

      - name: Probe wgpu smoke (diagnostic)
        shell: bash
        env:
          MBT_WGPU_DEBUG_REQUEST_ADAPTER: "1"
          MBT_WGPU_DEBUG_REQUEST_DEVICE: "1"
          MBT_WGPU_LOG_STDERR: "1"
          MBT_WGPU_LOG_LEVEL: "debug"
        run: |
          set -euo pipefail
          moon run --target native src/cmd/main/main.mbt

      - name: Run full test suite
        shell: bash
        env:
          MBT_WGPU_DEBUG_REQUEST_ADAPTER: "1"
          MBT_WGPU_DEBUG_REQUEST_DEVICE: "1"
        run: |
          set -euo pipefail
          moon test --target native --test-failure-json

      - name: Package contents sanity (exclude artifacts)
        shell: bash
        run: |
          set -euo pipefail
          # `moon package --list` includes status lines like "Running moon check ..." and
          # "Package to .../_build/..."; we only want to validate the file list (one path per line).
          moon package --list | awk '!/ /{print}' > package_files.txt
          if grep -nE '(^|/)(trace\.json|_build|target|src/c/target|vendor)(/|$)' package_files.txt; then
            echo "Unexpected build artifacts included in publish package."
            exit 1
          fi

  macos:
    name: macOS Metal (full)
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system deps (bindgen)
        shell: bash
        run: |
          set -euo pipefail
          brew install llvm
          echo "LIBCLANG_PATH=$(brew --prefix llvm)/lib" >> "$GITHUB_ENV"
          echo "$(brew --prefix llvm)/bin" >> "$GITHUB_PATH"

      - name: Install MoonBit
        shell: bash
        run: |
          set -euo pipefail
          curl -fsSL https://cli.moonbitlang.com/install/unix.sh | bash
          echo "MOON_HOME=$HOME/.moon" >> "$GITHUB_ENV"
          echo "$HOME/.moon/bin" >> "$GITHUB_PATH"

      - name: Moon version
        shell: bash
        run: moon version --all

      - name: Lint (moon check)
        shell: bash
        run: moon check

      - name: Build wgpu-native (Metal)
        shell: bash
        run: |
          set -euo pipefail
          git clone --depth 1 --recurse-submodules --shallow-submodules https://github.com/gfx-rs/wgpu-native "$RUNNER_TEMP/wgpu-native"
          cd "$RUNNER_TEMP/wgpu-native"
          git fetch --depth 1 origin "$WGPU_NATIVE_REV"
          git checkout "$WGPU_NATIVE_REV"
          git submodule update --init --recursive --depth 1
          cargo build --release --no-default-features --features metal,wgsl,spirv
          echo "MBT_WGPU_NATIVE_LIB=$RUNNER_TEMP/wgpu-native/target/release/libwgpu_native.dylib" >> "$GITHUB_ENV"

      - name: Run full test suite
        shell: bash
        run: |
          set -euo pipefail
          moon test --target native --test-failure-json

  windows:
    name: Windows (Mesa Vulkan, full)
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system deps (bindgen)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          choco install -y llvm
          choco install -y 7zip
          # Provide Vulkan loader/runtime (vulkan-1.dll) on GitHub-hosted runners.
          choco install -y vulkan-sdk
          "LIBCLANG_PATH=C:\Program Files\LLVM\bin" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

      - name: Install MoonBit
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $zipUrl = "https://cli.moonbitlang.com/binaries/latest/moonbit-windows-x86_64.zip"
          $zipPath = Join-Path $env:RUNNER_TEMP "moonbit.zip"
          $coreUrl = "https://cli.moonbitlang.com/cores/core-latest.zip"
          $coreZipPath = Join-Path $env:RUNNER_TEMP "core.zip"
          $moonHome = Join-Path $env:USERPROFILE ".moon"
          $moonLib = Join-Path $moonHome "lib"

          Invoke-WebRequest -Uri $zipUrl -OutFile $zipPath
          New-Item -ItemType Directory -Force -Path $moonHome | Out-Null
          Expand-Archive -Path $zipPath -DestinationPath $moonHome -Force

          # The Windows zip does not include the standard library checkout.
          # Install core explicitly (mirrors unix.sh install logic).
          Invoke-WebRequest -Uri $coreUrl -OutFile $coreZipPath
          New-Item -ItemType Directory -Force -Path $moonLib | Out-Null
          Remove-Item -Recurse -Force -ErrorAction SilentlyContinue (Join-Path $moonLib "core")
          Expand-Archive -Path $coreZipPath -DestinationPath $moonLib -Force

          "MOON_HOME=$moonHome" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          (Join-Path $moonHome "bin") | Out-File -FilePath $env:GITHUB_PATH -Append -Encoding utf8

          # Bundle core so `moon check` can inject `moonbitlang/core`.
          $env:MOON_HOME = $moonHome
          $env:PATH = (Join-Path $moonHome "bin") + ";" + $env:PATH
          moon bundle --warn-list -a --all --source-dir (Join-Path $moonLib "core")
          moon bundle --warn-list -a --target wasm-gc --source-dir (Join-Path $moonLib "core") --quiet

      - name: Moon version
        shell: pwsh
        run: moon version --all

      - name: Lint (moon check)
        shell: pwsh
        run: moon check

      - name: Install Mesa (software OpenGL)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $mesaUrl = "https://github.com/pal1000/mesa-dist-win/releases/download/25.3.3/mesa3d-25.3.3-release-msvc.7z"
          $mesa7z = Join-Path $env:RUNNER_TEMP "mesa3d.7z"
          $mesaDir = Join-Path $env:RUNNER_TEMP "mesa3d"
          Invoke-WebRequest -Uri $mesaUrl -OutFile $mesa7z
          New-Item -ItemType Directory -Force -Path $mesaDir | Out-Null
          7z x $mesa7z "-o$mesaDir" | Out-Host
          # Override OpenGL DLL and point Vulkan loader at the lavapipe ICD (if used by wgpu-native).
          (Join-Path $mesaDir "x64") | Out-File -FilePath $env:GITHUB_PATH -Append -Encoding utf8
          $vkIcd = Join-Path (Join-Path $mesaDir "x64") "lvp_icd.x86_64.json"
          "VK_ICD_FILENAMES=$vkIcd" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

      - name: Build wgpu-native (Vulkan)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          git clone --depth 1 --recurse-submodules --shallow-submodules https://github.com/gfx-rs/wgpu-native "$env:RUNNER_TEMP\wgpu-native"
          Set-Location "$env:RUNNER_TEMP\wgpu-native"
          git fetch --depth 1 origin $env:WGPU_NATIVE_REV
          git checkout $env:WGPU_NATIVE_REV
          git submodule update --init --recursive --depth 1
          cargo build --release --no-default-features --features vulkan,wgsl,spirv
          "MBT_WGPU_NATIVE_LIB=$env:RUNNER_TEMP\wgpu-native\target\release\wgpu_native.dll" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

      - name: Probe wgpu smoke (diagnostic)
        shell: pwsh
        env:
          MBT_WGPU_DEBUG_REQUEST_ADAPTER: "1"
          MBT_WGPU_DEBUG_REQUEST_DEVICE: "1"
          MBT_WGPU_LOG_STDERR: "1"
          MBT_WGPU_LOG_LEVEL: "debug"
        run: |
          $ErrorActionPreference = "Stop"
          moon run --target native src/cmd/main/main.mbt

      - name: Run full test suite
        shell: pwsh
        env:
          MBT_WGPU_DEBUG_REQUEST_ADAPTER: "1"
          MBT_WGPU_DEBUG_REQUEST_DEVICE: "1"
        run: |
          $ErrorActionPreference = "Stop"
          moon test --target native --test-failure-json
